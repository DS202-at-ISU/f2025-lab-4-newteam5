---
title: "Progress Report"
author: "NorahW3"
date: "2022-11-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(Lahman)
library(rvest)
library(dplyr)
library(stringr)
library(Lahman)
library(purrr)

```





```{r}

# Function to extract info from different pages of different years
extract_ballot_info <- function(html_hof) {
  txt <- html_hof |> html_elements("p") |> html_text()
  
  # Search for lines mentioning ballots
  line <- txt[str_detect(txt, regex("ballots", ignore_case = TRUE))][1]
  
  if (is.na(line)) return(list(ballots = NA_integer_, needed = NA_integer_))
  
  # Extract numbers more flexibly
  ballots <- str_extract(line, "\\d+(?=\\s*ballots?)")
  needed  <- str_extract(line, "\\d+(?=\\s*(votes? were needed|required))")
  
  list(
    ballots = as.integer(ballots),
    needed  = as.integer(needed)
  )
}
# Getting the correct format
get_hof_lahman_format <- function(year) {
  
  url <- paste0("https://www.baseball-reference.com/awards/hof_", year, ".shtml")
  html_hof <- tryCatch(read_html(url), error = function(e) return(NULL))
  if (is.null(html_hof)) return(NULL)
  
  node <- html_hof |> html_element("#hof_BBWAA")
  if (is.na(node)) return(NULL)
  
  tbl <- tryCatch(html_table(node, fill = TRUE), error = function(e) return(NULL))
  if (is.null(tbl)) return(NULL)
  
  colnames(tbl) <- make.unique(colnames(tbl))
  
  colnames(tbl) <- as.character(tbl[1, ])
  tbl <- tbl[-1, ]
  colnames(tbl) <- make.unique(colnames(tbl))  # again
  
  name_col  <- intersect(c("Player", "Name", "Players", "Candidate"), colnames(tbl))
  votes_col <- intersect(c("Votes", "Vote", "Votes Received"), colnames(tbl))
  yrs_col   <- intersect(c("Yrs on Ballot", "Yr", "Years"), colnames(tbl))
  
  if (length(name_col) == 0 || length(votes_col) == 0) return(NULL)
  
  tbl <- tbl %>%
    rename(
      name  = !!name_col[1],
      votes = !!votes_col[1]
    )
  
  if (length(yrs_col) > 0) {
    tbl <- tbl %>% rename(num = !!yrs_col[1])
  } else {
    tbl$num <- NA
  }
  
  tbl$votes <- suppressWarnings(as.integer(tbl$votes))
  
  tbl$inducted <- if_else(str_detect(tbl$name, "\\*"), "Y", "N")
  tbl$name <- str_remove(tbl$name, "\\*")
  
  ballot_info <- extract_ballot_info(html_hof)
  
  # Add Lahman fields
  tbl <- tbl %>%
    mutate(
      ballots = ballot_info$ballots,
      needed  = ballot_info$needed,
      needed_note = NA_character_,
      votedBy = "BBWAA",
      category = "Player",
      yearID = year
    )
  
  # Match names to Lahman People
  people_names <- People %>%
    mutate(fullName = paste(nameFirst, nameLast)) %>%
    select(playerID, fullName)
  
  tbl <- tbl %>%
    left_join(people_names, by = c("name" = "fullName")) %>%
    mutate(playerID = if_else(is.na(playerID), "unk", playerID))
  
  # Reorder to Lahman format
  tbl <- tbl %>%
    select(
      playerID, yearID, votedBy, ballots, needed, votes,
      inducted, category, needed_note, num
    )
  
  return(tbl)
}
years <- 2025:2010

hof_lahman <- map_df(years, get_hof_lahman_format)

hof_lahman <- hof_lahman %>%
  select(-last_col()) %>%
  arrange(playerID)

hof_lahman
subset(HallOfFame, yearID >= 2010)

readr::write_csv(hof_lahman, file="HallOfFame_2025.csv")

```















